---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { User, ArrowRight, FileText, ArrowLeft } from 'lucide-astro';

export async function getStaticPaths() {
  const allPosts = await getCollection('blog', ({ data }) => {
    const now = new Date();
    return data.draft !== true && data.date <= now;
  });

  // Get unique categories
  const categories = [...new Set(allPosts.map(post => post.data.category))];

  return categories.map((category) => {
    const categorySlug = category.toLowerCase().replace(/\s+/g, '-');
    const categoryPosts = allPosts
      .filter(post => post.data.category === category)
      .sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());

    return {
      params: { categoria: categorySlug },
      props: {
        category,
        posts: categoryPosts,
        totalPosts: categoryPosts.length
      },
    };
  });
}

interface Props {
  category: string;
  posts: any[];
  totalPosts: number;
}

const { category, posts, totalPosts } = Astro.props;

function formatDate(date: Date) {
  return date.toLocaleDateString('pt-BR', {
    year: 'numeric',
    month: 'long',
    day: 'numeric',
  });
}

function getExcerpt(post: any) {
  return post.data.description || 'Sem descrição disponível.';
}

function getCategoryColor(category: string) {
  const colors = [
    'bg-red-500', 'bg-orange-500', 'bg-amber-500', 'bg-yellow-500',
    'bg-lime-500', 'bg-green-500', 'bg-emerald-500', 'bg-teal-500',
    'bg-cyan-500', 'bg-sky-500', 'bg-blue-500', 'bg-indigo-500',
    'bg-violet-500', 'bg-purple-500', 'bg-fuchsia-500', 'bg-pink-500',
    'bg-rose-500'
  ];

  const firstChar = category.charAt(0).toLowerCase().charCodeAt(0);
  const lastChar = category.charAt(category.length - 1).toLowerCase().charCodeAt(0);
  const colorIndex = (firstChar + lastChar) % colors.length;

  return colors[colorIndex];
}
---

<BaseLayout
  title={`${category} - Coders.ia.br`}
  description={`Explore todos os artigos sobre ${category}. Aprenda com nossos tutoriais e insights especializados.`}
>
  <div class="container mx-auto px-4 py-8">
    <!-- Breadcrumb -->
    <nav class="mb-8 text-sm">
      <ol class="flex items-center space-x-2 text-slate-400">
        <li><a href="/" class="hover:text-accent-400 transition-colors">Home</a></li>
        <li><span class="mx-2">/</span></li>
        <li><a href="/categorias" class="hover:text-accent-400 transition-colors">Categorias</a></li>
        <li><span class="mx-2">/</span></li>
        <li class="text-slate-300">{category}</li>
      </ol>
    </nav>

    <!-- Page Header -->
    <div class="text-center mb-12">
      <div class="flex items-center justify-center space-x-3 mb-4">
        <div class={`w-4 h-4 ${getCategoryColor(category)} rounded-full`}></div>
        <h1 class="text-4xl md:text-5xl font-bold text-white">
          {category}
        </h1>
      </div>

      <p class="text-lg text-slate-300 mb-4">
        {totalPosts} {totalPosts === 1 ? 'artigo' : 'artigos'} sobre {category}
      </p>

      <div class="w-24 h-1 bg-gradient-to-r from-accent-500 to-primary-500 mx-auto rounded-full"></div>
    </div>

    <!-- Posts Grid -->
    {posts.length > 0 ? (
      <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-6">
        {posts.map((post) => (
          <article class="bg-slate-800/30 rounded-xl overflow-hidden border border-slate-700 hover:border-slate-600 transition-all duration-300 hover:shadow-xl hover:shadow-accent-500/5 group hover:-translate-y-1">
            <div class="p-6">
              <div class="flex items-center justify-between mb-4">
                <time class="text-xs text-slate-400">{formatDate(post.data.date)}</time>
                <div class="flex items-center space-x-2 text-xs text-slate-400">
                  <User class="w-3 h-3" />
                  <span>{post.data.author}</span>
                </div>
              </div>

              <h2 class="text-xl font-semibold text-white mb-3 leading-tight group-hover:text-accent-400 transition-colors duration-200">
                <a href={`/blog/${post.slug}`} class="line-clamp-2">
                  {post.data.title}
                </a>
              </h2>

              <p class="text-slate-300 text-sm mb-6 leading-relaxed line-clamp-3">
                {getExcerpt(post)}
              </p>

              <div class="flex items-center justify-between">
                <a
                  href={`/blog/${post.slug}`}
                  class="inline-flex items-center space-x-2 text-accent-400 hover:text-accent-300 text-sm font-medium transition-colors duration-200"
                >
                  <span>Ler artigo</span>
                  <ArrowRight class="w-4 h-4 group-hover:translate-x-1 transition-transform duration-200" />
                </a>
              </div>
            </div>
          </article>
        ))}
      </div>
    ) : (
      <!-- Empty State -->
      <div class="text-center py-16">
        <div class="w-24 h-24 bg-slate-800 rounded-full flex items-center justify-center mx-auto mb-6">
          <FileText class="w-12 h-12 text-slate-500" />
        </div>
        <h2 class="text-2xl font-semibold text-white mb-2">Nenhum post encontrado</h2>
        <p class="text-slate-400 mb-6">Parece que ainda não temos posts nesta categoria.</p>
        <a
          href="/categorias"
          class="inline-flex items-center space-x-2 px-4 py-2 bg-accent-600 hover:bg-accent-500 text-white rounded-lg font-medium transition-colors duration-200"
        >
          <span>Ver todas as categorias</span>
          <ArrowRight class="w-4 h-4" />
        </a>
      </div>
    )}

    <!-- Back to Categories -->
    <div class="mt-12 text-center">
      <a
        href="/categorias"
        class="inline-flex items-center space-x-2 text-slate-400 hover:text-accent-400 transition-colors duration-200"
      >
        <ArrowLeft class="w-4 h-4" />
        <span>Voltar para todas as categorias</span>
      </a>
    </div>
  </div>
</BaseLayout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .line-clamp-3 {
    display: -webkit-box;
    -webkit-line-clamp: 3;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }
</style>